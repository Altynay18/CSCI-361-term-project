<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<style>
table {
  border: 1px solid black;
}
</style>
</head>

<body>
<a class="btn btn-outline-primary" th:href="@{/}">Main page</a>
<h2>Search Available rooms</h2>
<p>Click on the button to open the dropdown menu, and use the input field to search for a specific available room.</p>

<form onsubmit="return false">

<h3>Choose period: </h3>
<label for="browser">From:</label>
  <input type="date" id="from-date" required>

<label for="browser">To:</label>
  <input type="date" id="to-date" required>
  
  <input type="submit" value="Search" id="search" onclick="availableRooms()">
  <input type="reset">
  
<h3>Additional criteria: </h3>

<label for="browser">Country:</label>
<input list="country" id="myCountry" onchange="getCityList(),getRoomtypeList()">
<datalist id="country">
</datalist>

<label for="browser">City:</label>
<input list="city" id="myCity" onchange="getRoomtypeList()">
<datalist id="city">
</datalist>

<label for="browser">Room Type:</label>
<input list="roomtype" id="myRoomtype">
<datalist id="roomtype">
</datalist>

<label for="browser">Capacity:</label>
<input type="number" list="capacity" id="myCapacity">
<datalist id="capacity">
</datalist>

<label for="browser">Season:</label>
<input list="season" id="mySeason">
<datalist id="season">
</datalist>
</form>
<br> <br>

<table style="width:70%" id="my-list"></table>

<script>

function updateList(items, tag) {
    $(tag).html("");
//    $(tag).append("<option value=\"Default\">");
    items.forEach(function (e) {
        $(tag).append("<option value=\""+e+"\">");
    });
}

function availableRooms() {
	var myUrl = "search/available?";
	var country = document.getElementById("myCountry").value;
	var city = document.getElementById("myCity").value;
	var roomtype = document.getElementById("myRoomtype").value;
	var capacity = document.getElementById("myCapacity").value;
	var from = document.getElementById("from-date").value;
	var to = document.getElementById("to-date").value;
	var season = document.getElementById("mySeason").value;
	
	if (country != "") {
		myUrl = myUrl+"country="+country+"&";
	}
	if (city != "") {
		myUrl = myUrl+"city="+city+"&";
	}
	if (roomtype != "") {
		myUrl = myUrl+"roomtype="+roomtype+"&";
	}
	if (capacity != "") {
		myUrl = myUrl+"capacity="+capacity+"&";
	}
	if (from != "") {
		myUrl = myUrl+"from="+from+"&";
	if (to != "")
		myUrl = myUrl+"to="+to+"&";
	}
	if (season != ""){
		myUrl = myUrl+"season="+season+"&";
	}

	$.ajax({
        url : myUrl,
        dataType : 'json',
        success : function(r) {
        	$("#my-list").html("");
        	if(!$.trim(r)){
        		$("#my-list").append("Sorry, No available rooms found. Try to search for other criterias.");
        	
        	} else {
    			$("#my-list").append("<label for=\"browser\">Available rooms:</label><br>");
            	$("#my-list").append("<tr><th>Country</th><th>City</th><th>Room Type</th><th>Capacity</th><th>Season</th><th>Price per day</th></tr>");
        	var size = 0, count = 0;
            	r.forEach(function (e) {
            		size = size + 1;
        		var seasontemp;
        		e.roomType.hotel.seasons.forEach(function(s) {
        			if (s.startDate <= from && to <= s.endDate) {
        				seasontemp = s;
        			} else if (s.startDate <= from) {
        				seasontemp = s;
        			} else {
        				seasontemp={"seasonName": "no season", "rate" : 1};
        			}
        		});
        		if (season != "" && season != seasontemp.seasonName) {
        			count = count+1;
        		} else {

        		 $("#my-list").append("<tr><td>"+e.roomType.hotel.country+"</td><td>"+e.roomType.hotel.city+
        				"</td><td>"+e.room_id.room_type_id.room_type_name+"</td><td>"+e.roomType.capacity+
        				"</td><td>"+seasontemp.seasonName+"</td><td>"+e.roomType.price*seasontemp.rate+"</td><td><a href=\"bookingform\?room_number="+
        						e.room_id.room_number+"&room_type="+e.room_id.room_type_id.room_type_name+
        						"&hotel_id="+e.room_id.room_type_id.hotel_id+"&from-date="+
        						document.getElementById("from-date").value + "&to-date=" + 
        						document.getElementById("to-date").value+"&bill="+e.roomType.price*seasontemp.rate+"\"><button type=\"button\">"+
        				"Book"+"</button></a></td></tr>");  
	}
          }); 
            	if (count == size) {
            		$("#my-list").append("Sorry, Available rooms does not match chosen season.");
            	}
        }}
    });

}

function getCountryList() {
    $.ajax({
        url : 'search/countries',
        dataType : 'json',
        success : function(r) {
            updateList(r, "#country");
        }
    });
}

function bookHotel(index) {

	$.ajax({
		url : 'search/hotel/',
		dataType : 'json',
		success : function(r) {
		//	updateList(r);
		}
	});
} 


function getCityList() {
	var country = document.getElementById("myCountry").value;
	var myUrl;
	if (country == "")
		myUrl = 'search/cities';
	else
		myUrl = 'search/cities?country='+country;
    $.ajax({
        url : myUrl,
        dataType : 'json',
        success : function(r) {
            updateList(r, "#city");
        }
    });
}

function getRoomtypeList() {
	var country = document.getElementById("myCountry").value;
	var city = document.getElementById("myCity").value;
	var myUrl="search/roomtypes?";
	
	if (country != "") {
		myUrl = myUrl+"country="+country+"&";
	}
	if (city != "") {
		myUrl = myUrl+"city="+city;
	}
	
    $.ajax({
        url : myUrl,
        dataType : 'json',
        success : function(r) {
            updateList(r, "#roomtype");
        }
    });
}

function getSeasonList() {
    $.ajax({
        url : 'search/season',
        dataType : 'json',
        success : function(r) {
            updateList(r, "#season");
        }
    });
}

$(document).ready(function () {
	getCountryList();
	getCityList();
	getRoomtypeList();
	getSeasonList();


});
</script>

</body>
</html>
